name: ggmpilot-demo

# Docker Compose configuration for running the full ggmpilot demo in containers.
# Goal: you can run the complete pipeline with Docker only (no host scripts).
#
# Usage:
#   docker compose -f docker/demo/docker-compose.yml up --build --abort-on-container-exit
#   docker compose -f docker/demo/docker-compose.yml down -v
#
# Optional:
#   docker compose -f docker/demo/docker-compose.yml --profile db-only up -d
#   docker compose -f docker/demo/docker-compose.yml --profile external up --build --abort-on-container-exit

services:
  # PostgreSQL database for the demo (source + destination)
  demo-db:
    image: postgres:16
    container_name: ggmpilot-demo-db
    environment:
      POSTGRES_USER: ${DEMO_DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DEMO_DB_PASSWORD:-postgres}
      POSTGRES_DB: ${DEMO_DB_NAME:-demo}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DEMO_DB_USER:-postgres} -d ${DEMO_DB_NAME:-demo}"]
      interval: 2s
      timeout: 5s
      retries: 30
    ports:
      # Expose to host for inspection; can be overridden with DEMO_DB_PORT
      - "${DEMO_DB_PORT:-55432}:5432"
    volumes:
      # Persist data across runs (optional)
      - demo-db-data:/var/lib/postgresql/data

  # Convenience profile: start only the database (handy for development)
  demo-db-only:
    image: postgres:16
    container_name: ggmpilot-demo-db-only
    profiles:
      - db-only
    environment:
      POSTGRES_USER: ${DEMO_DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DEMO_DB_PASSWORD:-postgres}
      POSTGRES_DB: ${DEMO_DB_NAME:-demo}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DEMO_DB_USER:-postgres} -d ${DEMO_DB_NAME:-demo}"]
      interval: 2s
      timeout: 5s
      retries: 30
    ports:
      - "${DEMO_DB_PORT:-55432}:5432"
    volumes:
      - demo-db-data:/var/lib/postgresql/data

  # Main demo runner: generates synthetic data, runs both pipelines.
  # This is the default service to run for a fully containerized demo.
  demo-run:
    image: ${DEMO_APP_IMAGE:-ggmpilot:demo}
    build:
      context: ../..
      dockerfile: Dockerfile
    container_name: ggmpilot-demo-run
    depends_on:
      demo-db:
        condition: service_healthy
    working_dir: /app
    entrypoint: ["/bin/bash", "-lc", "sed -i 's/\r$//' /app/docker/demo/demo_entrypoint.sh && /app/docker/demo/demo_entrypoint.sh"]
    environment:
      IN_DOCKER: "1"
      PYTHONPATH: "/app"
      # Database connection - uses internal container port (5432), not host port
      DEMO_DB_HOST: ${DEMO_DB_HOST:-demo-db}
      DEMO_DB_PORT: "5432"  # Internal container port, not host port
      DEMO_DB_USER: ${DEMO_DB_USER:-postgres}
      DEMO_DB_PASSWORD: ${DEMO_DB_PASSWORD:-postgres}
      DEMO_DB_NAME: ${DEMO_DB_NAME:-demo}
      DEMO_DB_DRIVER: ${DEMO_DB_DRIVER:-postgresql+psycopg2}
      # Demo configuration
      DEMO_ROWS: ${DEMO_ROWS:-10}
      DEMO_SEED: ${DEMO_SEED:-123}
      # Skip steps (for partial runs)
      SKIP_GENERATE: ${SKIP_GENERATE:-0}
      SKIP_LOAD: ${SKIP_LOAD:-0}
      SKIP_SQL_TO_STAGING: ${SKIP_SQL_TO_STAGING:-0}
      SKIP_STAGING_TO_SILVER: ${SKIP_STAGING_TO_SILVER:-0}
    volumes:
      # Mount data dir for inspection / parquet dumps
      - type: bind
        source: ../../data
        target: /app/data
      # Optionally mount custom config
      # - ./my-config.ini:/app/docker/demo/config/custom.ini:ro

  # Alternative: run demo against external database (no bundled Postgres).
  demo-run-external:
    image: ${DEMO_APP_IMAGE:-ggmpilot:demo}
    build:
      context: ../..
      dockerfile: Dockerfile
    container_name: ggmpilot-demo-run-external
    profiles:
      - external
    working_dir: /app
    entrypoint: ["/bin/bash", "-lc", "sed -i 's/\r$//' /app/docker/demo/demo_entrypoint.sh && /app/docker/demo/demo_entrypoint.sh"]
    environment:
      IN_DOCKER: "1"
      PYTHONPATH: "/app"
      # User must provide these for external DB
      DEMO_DB_HOST: ${DEMO_DB_HOST:-host.docker.internal}
      DEMO_DB_PORT: ${DEMO_DB_PORT:-5432}
      DEMO_DB_USER: ${DEMO_DB_USER:-postgres}
      DEMO_DB_PASSWORD: ${DEMO_DB_PASSWORD:-postgres}
      DEMO_DB_NAME: ${DEMO_DB_NAME:-demo}
      DEMO_DB_DRIVER: ${DEMO_DB_DRIVER:-postgresql+psycopg2}
      DEMO_ROWS: ${DEMO_ROWS:-10}
      DEMO_SEED: ${DEMO_SEED:-123}
      SKIP_GENERATE: ${SKIP_GENERATE:-0}
      SKIP_LOAD: ${SKIP_LOAD:-0}
      SKIP_SQL_TO_STAGING: ${SKIP_SQL_TO_STAGING:-0}
      SKIP_STAGING_TO_SILVER: ${SKIP_STAGING_TO_SILVER:-0}
    extra_hosts:
      # Allow connecting to host machine databases
      - "host.docker.internal:host-gateway"
    volumes:
      - type: bind
        source: ../../data
        target: /app/data

volumes:
  demo-db-data:
