name: Docker demo test (Docker Compose)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  demo:
    runs-on: ubuntu-latest
    timeout-minutes: 12

    steps:
      - uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Pre-pull base images (cache warmup)
        run: |
          docker pull postgres:16
          docker pull python:3.12-slim
          docker pull ghcr.io/astral-sh/uv:latest || true

      - name: Build app image with cache
        uses: docker/build-push-action@v6
        with:
          context: .
          tags: ggmpilot:demo-ci
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Show Docker info
        run: |
          docker version
          docker info
          docker compose version || true

      - name: Run docker demo (Compose; keep DB running)
        shell: bash
        run: |
          set -euo pipefail
          export DEMO_APP_IMAGE=ggmpilot:demo-ci
          docker compose -f docker/demo/docker-compose.yml up -d demo-db
          docker compose -f docker/demo/docker-compose.yml run --rm demo-run

      - name: Validate demo output (tables exist)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          # Verify a few expected tables in silver schema.
          docker ps -a
          docker exec ggmpilot-demo-db psql -U postgres -d demo -v ON_ERROR_STOP=1 -c "\
            SELECT table_schema, table_name\
            FROM information_schema.tables\
            WHERE table_schema IN ('source','staging','silver')\
            ORDER BY 1,2;\
          "
          # Table casing can differ depending on init SQL and naming config.
          # Prefer unquoted (lowercase) first, then quoted (uppercase).
          docker exec ggmpilot-demo-db bash -lc "\
            set -euo pipefail;\
            psql -U postgres -d demo -v ON_ERROR_STOP=1 -c 'SELECT count(*) AS client_rows FROM silver.client;' \
              || psql -U postgres -d demo -v ON_ERROR_STOP=1 -c 'SELECT count(*) AS client_rows FROM silver."CLIENT";';\
          "

      - name: Dump logs (on failure)
        if: failure()
        shell: bash
        run: |
          set +e
          docker compose -f docker/demo/docker-compose.yml ps
          docker compose -f docker/demo/docker-compose.yml logs --no-color | tail -n 500

      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker/demo/docker-compose.yml down -v --remove-orphans
